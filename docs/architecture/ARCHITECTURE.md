# ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

## ğŸ“‹ ç›®æ¬¡

1. [æ¦‚è¦](#æ¦‚è¦)
2. [ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£](#ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£)
3. [ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼](#ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼)
4. [ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³](#ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³)
5. [ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«](#ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«)
6. [ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ](#ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ )
7. [ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£](#ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£)
8. [ãƒ¬ã‚¸ãƒªã‚¨ãƒ³ã‚¹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£](#ãƒ¬ã‚¸ãƒªã‚¨ãƒ³ã‚¹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£)
9. [å¤šè¨€èªã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£](#å¤šè¨€èªã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£)
10. [ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–](#ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–)

---

## æ¦‚è¦

### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®è¨­è¨ˆåŸå‰‡

1. **ã‚·ãƒ³ãƒ—ãƒ«ã•**: å¿…è¦æœ€å°é™ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§æ§‹æˆ
2. **æ‹¡å¼µæ€§**: å°†æ¥çš„ãªã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã«å¯¾å¿œ
3. **ä¿å®ˆæ€§**: ç†è§£ã—ã‚„ã™ãã€ä¿®æ­£ã—ã‚„ã™ã„æ§‹é€ 
4. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: å¤šå±¤é˜²å¾¡ã«ã‚ˆã‚‹å®‰å…¨æ€§ç¢ºä¿
5. **ãƒ¬ã‚¸ãƒªã‚¨ãƒ³ã‚¹**: éšœå®³ã«å¼·ã„è‡ªå‹•å¾©æ—§æ©Ÿèƒ½

### ä¸»è¦æŠ€è¡“æ±ºå®š

| æŠ€è¡“é¸å®š | ç†ç”± |
|---------|------|
| **FastAPI** | é«˜é€Ÿã€å‹å®‰å…¨ã€è‡ªå‹•APIæ–‡æ›¸ç”Ÿæˆ |
| **SQLite** | ã‚·ãƒ³ãƒ—ãƒ«ã€ãƒ•ã‚¡ã‚¤ãƒ«ãƒ™ãƒ¼ã‚¹ã€ä¾å­˜é–¢ä¿‚ãªã— |
| **Uvicorn** | é«˜é€ŸASGIã€éåŒæœŸå¯¾å¿œ |
| **Apache HTTPD** | å®Ÿç¸¾è±Šå¯Œã€SSL/TLSå¯¾å¿œã€Basicèªè¨¼ |
| **OpenAI API** | é«˜ç²¾åº¦AIã€ã‚³ã‚¹ãƒˆåŠ¹ç‡çš„ï¼ˆgpt-4o-miniï¼‰ |
| **systemd** | æ¨™æº–çš„ãªãƒ—ãƒ­ã‚»ã‚¹ç®¡ç†ã€è‡ªå‹•å†èµ·å‹• |

---

## ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### å…¨ä½“æ§‹æˆå›³

```mermaid
graph TB
    subgraph "Internet"
        User[ãƒ¦ãƒ¼ã‚¶ãƒ¼<br/>Webãƒ–ãƒ©ã‚¦ã‚¶]
    end

    subgraph "EC2 Instance"
        subgraph "Apache HTTPD Layer"
            Apache[Apache HTTPD 2.4.62<br/>Port 443/80<br/>- SSL/TLS Termination<br/>- Basic Authentication<br/>- Reverse Proxy]
        end

        subgraph "Application Layer"
            SystemD[systemd<br/>estimator.service<br/>- Auto-restart<br/>- Log management]

            Uvicorn[Uvicorn ASGI Server<br/>127.0.0.1:8100<br/>- Async processing<br/>- Timeout: 120s]

            FastAPI[FastAPI Application<br/>Python 3.11<br/>- REST API<br/>- Multi-language ja/en]
        end

        subgraph "Service Layer"
            TaskSvc[TaskService<br/>ã‚¿ã‚¹ã‚¯ç®¡ç†]
            QuestionSvc[QuestionService<br/>è³ªå•ç”Ÿæˆ]
            EstimateSvc[EstimatorService<br/>è¦‹ç©ã‚Šè¨ˆç®—]
            ChatSvc[ChatService<br/>èª¿æ•´ææ¡ˆ]
            SafetySvc[SafetyService<br/>å®‰å…¨æ€§æ¤œè¨¼]
            InputSvc[InputService<br/>ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†]
            ExportSvc[ExportService<br/>Excelå‡ºåŠ›]
        end

        subgraph "Data Layer"
            SQLite[(SQLite Database<br/>app.db<br/>- tasks<br/>- deliverables<br/>- qa_pairs<br/>- estimates<br/>- messages)]
        end
    end

    subgraph "External Services"
        OpenAI[OpenAI API<br/>OpenAI<br/>- Question generation<br/>- Estimate generation<br/>- Chat adjustment]
    end

    User -->|HTTPS| Apache
    Apache -->|HTTP| SystemD
    SystemD -->|Process| Uvicorn
    Uvicorn -->|ASGI| FastAPI

    FastAPI --> TaskSvc
    FastAPI --> QuestionSvc
    FastAPI --> EstimateSvc
    FastAPI --> ChatSvc
    FastAPI --> SafetySvc
    FastAPI --> InputSvc
    FastAPI --> ExportSvc

    TaskSvc --> SQLite
    QuestionSvc --> SQLite
    QuestionSvc --> OpenAI
    EstimateSvc --> SQLite
    EstimateSvc --> OpenAI
    ChatSvc --> SQLite
    ChatSvc --> OpenAI
    InputSvc --> SQLite
    ExportSvc --> SQLite
```

### ãƒ¬ã‚¤ãƒ¤ãƒ¼è©³ç´°

#### 1. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ¬ã‚¤ãƒ¤ãƒ¼

**æ§‹æˆ**:
- Vanilla JavaScript
- Chart.js (ã‚°ãƒ©ãƒ•æç”»)
- HTML5/CSS3

**è²¬å‹™**:
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹è¡¨ç¤º
- ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã®åé›†
- APIå‘¼ã³å‡ºã—
- çµæœã®è¦–è¦šåŒ–

#### 2. ãƒ—ãƒ­ã‚­ã‚·ãƒ¬ã‚¤ãƒ¤ãƒ¼ (Apache HTTPD)

**è²¬å‹™**:
- SSL/TLSçµ‚ç«¯
- Basicèªè¨¼
- ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·
- HTTPâ†’HTTPSãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ

**è¨­å®š**:
```apache
ProxyPass /api/ http://127.0.0.1:8100/api/ timeout=600
ProxyPass /static/ http://127.0.0.1:8100/static/ timeout=600
ProxyPass / http://127.0.0.1:8100/ui/ timeout=600
```

#### 3. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¬ã‚¤ãƒ¤ãƒ¼ (FastAPI)

**è²¬å‹™**:
- REST APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆæä¾›
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
- ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè¡Œ
- ãƒ¬ã‚¹ãƒãƒ³ã‚¹ç”Ÿæˆ

**ä¸»è¦ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**:
- `POST /api/v1/tasks` - ã‚¿ã‚¹ã‚¯ä½œæˆ
- `GET /api/v1/tasks/{id}/questions` - è³ªå•å–å¾—
- `POST /api/v1/tasks/{id}/answers` - å›ç­”é€ä¿¡
- `GET /api/v1/tasks/{id}/result` - çµæœå–å¾—
- `POST /api/v1/tasks/{id}/chat` - èª¿æ•´ãƒªã‚¯ã‚¨ã‚¹ãƒˆ

#### 4. ã‚µãƒ¼ãƒ“ã‚¹ãƒ¬ã‚¤ãƒ¤ãƒ¼

**TaskService**:
- ã‚¿ã‚¹ã‚¯ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ç®¡ç†
- è¦‹ç©ã‚Šãƒ—ãƒ­ã‚»ã‚¹å…¨ä½“ã®åˆ¶å¾¡

**QuestionService**:
- AIè³ªå•ç”Ÿæˆ
- OpenAI APIã¨ã®é€£æº

**EstimatorService**:
- è¦‹ç©ã‚Šè¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯
- å·¥æ•°ãƒ»é‡‘é¡ç®—å‡º

**ChatService**:
- èª¿æ•´ææ¡ˆç”Ÿæˆ
- AIå¯¾è©±åˆ¶å¾¡

**SafetyService**:
- ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³æ¤œå‡º
- ä¸é©åˆ‡ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°

**InputService**:
- Excel/CSVãƒ‘ãƒ¼ã‚¹
- ãƒ‡ãƒ¼ã‚¿æŠ½å‡ºãƒ»ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³

**ExportService**:
- Excelãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆ
- ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæ•´å½¢

#### 5. ãƒ‡ãƒ¼ã‚¿ãƒ¬ã‚¤ãƒ¤ãƒ¼ (SQLite)

**è²¬å‹™**:
- ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ–
- ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†
- ã‚¯ã‚¨ãƒªå®Ÿè¡Œ

---

## ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

### ã‚¿ã‚¹ã‚¯ä½œæˆã€œè¦‹ç©ã‚Šç”Ÿæˆãƒ•ãƒ­ãƒ¼

```mermaid
sequenceDiagram
    actor User as ãƒ¦ãƒ¼ã‚¶ãƒ¼
    participant UI as Web UI
    participant API as FastAPI
    participant Safety as SafetyService
    participant Input as InputService
    participant Task as TaskService
    participant Question as QuestionService
    participant Estimator as EstimatorService
    participant Export as ExportService
    participant DB as SQLite
    participant OpenAI as OpenAI API

    User->>UI: 1. æˆæœç‰©å…¥åŠ›<br/>(Excel/CSV/Webãƒ•ã‚©ãƒ¼ãƒ )
    UI->>API: POST /api/v1/tasks

    API->>Safety: 2. å®‰å…¨æ€§ãƒã‚§ãƒƒã‚¯
    Safety-->>API: OK

    API->>Input: 3. ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†
    Input->>Input: Excel/CSVãƒ‘ãƒ¼ã‚¹
    Input->>DB: 4. ã‚¿ã‚¹ã‚¯ä½œæˆ
    DB-->>Input: task_id
    Input->>DB: 5. æˆæœç‰©ä¿å­˜
    Input-->>API: task
    API-->>UI: TaskResponse

    UI->>API: 6. GET /tasks/{id}/questions
    API->>Question: è³ªå•ç”Ÿæˆãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    Question->>DB: æˆæœç‰©ãƒ»è¦ä»¶å–å¾—
    DB-->>Question: deliverables, requirements

    Question->>OpenAI: 7. LLMãƒ—ãƒ­ãƒ³ãƒ—ãƒˆé€ä¿¡<br/>(è³ªå•ç”Ÿæˆ)
    OpenAI-->>Question: 3ã¤ã®è³ªå•

    Question->>DB: 8. è³ªå•ä¿å­˜
    Question-->>API: questions
    API-->>UI: QuestionsResponse

    UI->>User: 9. è³ªå•è¡¨ç¤º
    User->>UI: 10. å›ç­”å…¥åŠ›
    UI->>API: POST /tasks/{id}/answers

    API->>DB: 11. å›ç­”ä¿å­˜
    API->>Task: 12. è¦‹ç©ã‚Šç”Ÿæˆé–‹å§‹

    loop å„æˆæœç‰©
        Task->>Estimator: è¦‹ç©ã‚Šç”Ÿæˆ
        Estimator->>OpenAI: LLMãƒ—ãƒ­ãƒ³ãƒ—ãƒˆé€ä¿¡<br/>(è¦‹ç©ã‚Šç”Ÿæˆ)
        OpenAI-->>Estimator: å·¥æ•°ãƒ»é‡‘é¡ãƒ»æ ¹æ‹ 
        Estimator->>DB: è¦‹ç©ã‚Šä¿å­˜
    end

    Task->>Estimator: 13. åˆè¨ˆè¨ˆç®—
    Estimator->>Estimator: å°è¨ˆãƒ»ç¨é¡ãƒ»ç·é¡è¨ˆç®—

    Task->>Export: 14. Excelç”Ÿæˆ
    Export->>DB: ãƒ‡ãƒ¼ã‚¿å–å¾—
    DB-->>Export: estimates, qa_pairs
    Export->>Export: Excelãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
    Export-->>Task: file_path

    Task->>DB: 15. çµæœä¿å­˜
    Task-->>API: success
    API-->>UI: AnswersResponse

    UI->>API: 16. GET /tasks/{id}/result
    API->>DB: çµæœå–å¾—
    DB-->>API: estimates, totals
    API-->>UI: ResultResponse
    UI->>User: 17. è¦‹ç©ã‚Šè¡¨ç¤º
```

### ãƒãƒ£ãƒƒãƒˆèª¿æ•´ãƒ•ãƒ­ãƒ¼

```mermaid
sequenceDiagram
    actor User as ãƒ¦ãƒ¼ã‚¶ãƒ¼
    participant UI as Web UI
    participant API as FastAPI
    participant Safety as SafetyService
    participant Chat as ChatService
    participant DB as SQLite
    participant OpenAI as OpenAI API

    User->>UI: 1. èª¿æ•´ãƒªã‚¯ã‚¨ã‚¹ãƒˆå…¥åŠ›<br/>("30ä¸‡å††å®‰ãã—ã¦")
    UI->>API: POST /tasks/{id}/chat

    API->>Safety: 2. å®‰å…¨æ€§ãƒã‚§ãƒƒã‚¯
    Safety-->>API: OK

    API->>Chat: 3. èª¿æ•´ææ¡ˆç”Ÿæˆ
    Chat->>DB: ç¾åœ¨ã®è¦‹ç©ã‚Šå–å¾—
    DB-->>Chat: current_estimates

    Chat->>Chat: 4. èª¿æ•´ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ<br/>(direction, amount)
    Chat->>OpenAI: 5. LLMãƒ—ãƒ­ãƒ³ãƒ—ãƒˆé€ä¿¡<br/>(èª¿æ•´ææ¡ˆ)
    OpenAI-->>Chat: 3ã¤ã®ææ¡ˆ

    Chat->>DB: 6. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¿å­˜
    Chat-->>API: proposals
    API-->>UI: ChatResponse

    UI->>User: 7. ææ¡ˆã‚«ãƒ¼ãƒ‰è¡¨ç¤º
    User->>UI: 8. ææ¡ˆé¸æŠ
    UI->>API: POST /tasks/{id}/apply

    API->>DB: 9. è¦‹ç©ã‚Šæ›´æ–°
    API->>DB: 10. Excelå†ç”Ÿæˆ
    API-->>UI: success
    UI->>User: 11. æ›´æ–°å®Œäº†
```

---

## ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³

### ã‚¿ã‚¹ã‚¯ä½œæˆè©³ç´°ã‚·ãƒ¼ã‚±ãƒ³ã‚¹

```mermaid
sequenceDiagram
    participant Client as ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
    participant API as API Layer
    participant Safety as SafetyService
    participant Input as InputService
    participant Task as TaskService
    participant DB as Database

    Client->>API: POST /api/v1/tasks<br/>(file OR deliverables_json)

    alt ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        API->>API: ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯<br/>(< 10MB)
        API->>API: ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ãƒã‚§ãƒƒã‚¯<br/>(.xlsx, .xls, .csv)
    end

    API->>Safety: validate_and_reject()<br/>(system_requirements)

    alt Guardrailsãƒã‚§ãƒƒã‚¯
        Safety->>Safety: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³æ¤œå‡º
        Safety->>Safety: ä¸é©åˆ‡ã‚³ãƒ³ãƒ†ãƒ³ãƒ„æ¤œå‡º
        alt æ¤œå‡ºã•ã‚ŒãŸå ´åˆ
            Safety-->>API: HTTPException(400)
            API-->>Client: Error Response
        end
    end

    alt ãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆ
        API->>Input: load_excel_data(file_path)
        Input->>Input: openpyxl/pandasã§ãƒ‘ãƒ¼ã‚¹
        Input-->>API: deliverables_list
    else Webãƒ•ã‚©ãƒ¼ãƒ ã®å ´åˆ
        API->>API: JSON.parse(deliverables_json)
    end

    API->>Task: create_task(file_path, system_reqs)
    Task->>DB: INSERT INTO tasks
    DB-->>Task: task_id

    loop å„æˆæœç‰©
        Task->>DB: INSERT INTO deliverables
    end

    Task-->>API: TaskResponse
    API-->>Client: 200 OK + TaskResponse
```

### è¦‹ç©ã‚Šç”Ÿæˆè©³ç´°ã‚·ãƒ¼ã‚±ãƒ³ã‚¹

```mermaid
sequenceDiagram
    participant API as API Layer
    participant Task as TaskService
    participant Question as QuestionService
    participant Estimator as EstimatorService
    participant Circuit as CircuitBreaker
    participant Retry as RetryLogic
    participant OpenAI as OpenAI API
    participant DB as Database

    API->>Task: process_task(task_id, answers)
    Task->>DB: UPDATE qa_pairs SET answer

    Task->>DB: SELECT deliverables
    DB-->>Task: deliverables_list

    loop å„æˆæœç‰©ï¼ˆä¸¦åˆ—å®Ÿè¡Œï¼‰
        Task->>Estimator: estimate_deliverable()
        Estimator->>Circuit: check_state()

        alt CircuitBreaker CLOSED
            Circuit-->>Estimator: OK

            Estimator->>Retry: with_retry()
            loop æœ€å¤§3å›ãƒªãƒˆãƒ©ã‚¤
                Retry->>OpenAI: create_completion()

                alt æˆåŠŸ
                    OpenAI-->>Retry: response
                    Retry-->>Estimator: result
                else ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ/ã‚¨ãƒ©ãƒ¼
                    OpenAI-->>Retry: Error
                    Retry->>Retry: wait & retry
                end
            end

            alt 3å›ã¨ã‚‚å¤±æ•—
                Retry-->>Estimator: Error
                Estimator->>Circuit: record_failure()
                Circuit->>Circuit: increment_failure_count
            end

        else CircuitBreaker OPEN
            Circuit-->>Estimator: CircuitOpenError
            Estimator-->>Task: Fallbackå‡¦ç†
        end

        Estimator->>DB: INSERT INTO estimates
    end

    Task->>Estimator: calculate_totals()
    Estimator-->>Task: subtotal, tax, total

    Task->>DB: UPDATE tasks SET status=completed
    Task-->>API: success
```

---

## ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«

### ERå›³

```mermaid
erDiagram
    tasks ||--o{ deliverables : "has many"
    tasks ||--o{ qa_pairs : "has many"
    tasks ||--o{ messages : "has many"
    deliverables ||--o{ estimates : "has many"

    tasks {
        string id PK "UUID"
        string excel_file_path "ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹"
        text system_requirements "ã‚·ã‚¹ãƒ†ãƒ è¦ä»¶"
        string status "pending/processing/completed/failed"
        text error_message "ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸"
        string result_file_path "å‡ºåŠ›Excelãƒ‘ã‚¹"
        datetime created_at
        datetime updated_at
    }

    deliverables {
        string id PK "UUID"
        string task_id FK "ã‚¿ã‚¹ã‚¯ID"
        string name "æˆæœç‰©åç§°"
        text description "èª¬æ˜"
        datetime created_at
    }

    qa_pairs {
        string id PK "UUID"
        string task_id FK "ã‚¿ã‚¹ã‚¯ID"
        text question "è³ªå•"
        text answer "å›ç­”"
        datetime created_at
    }

    estimates {
        string id PK "UUID"
        string deliverable_id FK "æˆæœç‰©ID"
        float estimated_days "äºˆæƒ³å·¥æ•°(äººæ—¥)"
        float estimated_cost "äºˆæƒ³é‡‘é¡"
        json breakdown "å·¥æ•°å†…è¨³"
        text reasoning "æ ¹æ‹ ãƒ»å‚™è€ƒ"
        datetime created_at
    }

    messages {
        string id PK "UUID"
        string task_id FK "ã‚¿ã‚¹ã‚¯ID"
        string role "user/assistant"
        text content "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹"
        datetime created_at
    }
```

### ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«é–¢é€£

```mermaid
classDiagram
    class Task {
        +String id
        +String excel_file_path
        +Text system_requirements
        +TaskStatus status
        +Text error_message
        +String result_file_path
        +DateTime created_at
        +DateTime updated_at
        +List~Deliverable~ deliverables
        +List~QAPair~ qa_pairs
        +List~Message~ messages
    }

    class Deliverable {
        +String id
        +String task_id
        +String name
        +Text description
        +DateTime created_at
        +Task task
        +List~Estimate~ estimates
    }

    class QAPair {
        +String id
        +String task_id
        +Text question
        +Text answer
        +DateTime created_at
        +Task task
    }

    class Estimate {
        +String id
        +String deliverable_id
        +Float estimated_days
        +Float estimated_cost
        +JSON breakdown
        +Text reasoning
        +DateTime created_at
        +Deliverable deliverable
    }

    class Message {
        +String id
        +String task_id
        +String role
        +Text content
        +DateTime created_at
        +Task task
    }

    class TaskStatus {
        <<enumeration>>
        PENDING
        PROCESSING
        COMPLETED
        FAILED
    }

    Task "1" --> "*" Deliverable
    Task "1" --> "*" QAPair
    Task "1" --> "*" Message
    Deliverable "1" --> "*" Estimate
    Task --> TaskStatus
```

---

## ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 

```
output3/backend/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ main.py                    # FastAPIã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
â”‚   â”‚
â”‚   â”œâ”€â”€ api/                       # APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ v1/
â”‚   â”‚       â”œâ”€â”€ __init__.py
â”‚   â”‚       â””â”€â”€ tasks.py           # ã‚¿ã‚¹ã‚¯é–¢é€£API
â”‚   â”‚
â”‚   â”œâ”€â”€ models/                    # SQLAlchemyãƒ¢ãƒ‡ãƒ«
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ task.py               # Taskãƒ¢ãƒ‡ãƒ«
â”‚   â”‚   â”œâ”€â”€ deliverable.py        # Deliverableãƒ¢ãƒ‡ãƒ«
â”‚   â”‚   â”œâ”€â”€ qa_pair.py            # QAPairãƒ¢ãƒ‡ãƒ«
â”‚   â”‚   â”œâ”€â”€ estimate.py           # Estimateãƒ¢ãƒ‡ãƒ«
â”‚   â”‚   â””â”€â”€ message.py            # Messageãƒ¢ãƒ‡ãƒ«
â”‚   â”‚
â”‚   â”œâ”€â”€ schemas/                   # Pydanticã‚¹ã‚­ãƒ¼ãƒ
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ task.py               # ã‚¿ã‚¹ã‚¯é–¢é€£ã‚¹ã‚­ãƒ¼ãƒ
â”‚   â”‚   â”œâ”€â”€ estimate.py           # è¦‹ç©ã‚Šé–¢é€£ã‚¹ã‚­ãƒ¼ãƒ
â”‚   â”‚   â”œâ”€â”€ qa_pair.py            # QAé–¢é€£ã‚¹ã‚­ãƒ¼ãƒ
â”‚   â”‚   â””â”€â”€ chat.py               # ãƒãƒ£ãƒƒãƒˆé–¢é€£ã‚¹ã‚­ãƒ¼ãƒ
â”‚   â”‚
â”‚   â”œâ”€â”€ services/                  # ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ task_service.py       # ã‚¿ã‚¹ã‚¯ç®¡ç†ã‚µãƒ¼ãƒ“ã‚¹
â”‚   â”‚   â”œâ”€â”€ question_service.py   # è³ªå•ç”Ÿæˆã‚µãƒ¼ãƒ“ã‚¹
â”‚   â”‚   â”œâ”€â”€ estimator_service.py  # è¦‹ç©ã‚Šè¨ˆç®—ã‚µãƒ¼ãƒ“ã‚¹
â”‚   â”‚   â”œâ”€â”€ chat_service.py       # ãƒãƒ£ãƒƒãƒˆèª¿æ•´ã‚µãƒ¼ãƒ“ã‚¹
â”‚   â”‚   â”œâ”€â”€ safety_service.py     # å®‰å…¨æ€§æ¤œè¨¼ã‚µãƒ¼ãƒ“ã‚¹
â”‚   â”‚   â”œâ”€â”€ input_service.py      # ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã‚µãƒ¼ãƒ“ã‚¹
â”‚   â”‚   â””â”€â”€ export_service.py     # Excelå‡ºåŠ›ã‚µãƒ¼ãƒ“ã‚¹
â”‚   â”‚
â”‚   â”œâ”€â”€ core/                      # å…±é€šæ©Ÿèƒ½ãƒ»è¨­å®š
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ config.py             # è¨­å®šç®¡ç†
â”‚   â”‚   â””â”€â”€ i18n.py               # å¤šè¨€èªå¯¾å¿œ
â”‚   â”‚
â”‚   â”œâ”€â”€ db/                        # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ database.py           # DBæ¥ç¶šãƒ»ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
â”‚   â”‚
â”‚   â”œâ”€â”€ prompts/                   # LLMãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ question_prompts.py   # è³ªå•ç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
â”‚   â”‚   â”œâ”€â”€ estimate_prompts.py   # è¦‹ç©ã‚Šç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
â”‚   â”‚   â””â”€â”€ chat_prompts.py       # ãƒãƒ£ãƒƒãƒˆèª¿æ•´ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
â”‚   â”‚
â”‚   â”œâ”€â”€ middleware/                # ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ circuit_breaker.py    # ã‚µãƒ¼ã‚­ãƒƒãƒˆãƒ–ãƒ¬ãƒ¼ã‚«ãƒ¼
â”‚   â”‚   â”œâ”€â”€ loop_detector.py      # ãƒ«ãƒ¼ãƒ—æ¤œå‡º
â”‚   â”‚   â””â”€â”€ resource_limiter.py   # ãƒªã‚½ãƒ¼ã‚¹åˆ¶é™
â”‚   â”‚
â”‚   â”œâ”€â”€ utils/                     # ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ retry.py              # ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯
â”‚   â”‚
â”‚   â”œâ”€â”€ locales/                   # å¤šè¨€èªç¿»è¨³ãƒ•ã‚¡ã‚¤ãƒ«
â”‚   â”‚   â”œâ”€â”€ ja.json               # æ—¥æœ¬èªç¿»è¨³
â”‚   â”‚   â””â”€â”€ en.json               # è‹±èªç¿»è¨³
â”‚   â”‚
â”‚   â””â”€â”€ static/                    # é™çš„ãƒ•ã‚¡ã‚¤ãƒ«
â”‚       â”œâ”€â”€ index.html            # ãƒ¡ã‚¤ãƒ³UI
â”‚       â”œâ”€â”€ styles.css            # ã‚¹ã‚¿ã‚¤ãƒ«ã‚·ãƒ¼ãƒˆ
â”‚       â””â”€â”€ script.js             # ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰JS
â”‚
â”œâ”€â”€ tests/                         # ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ conftest.py               # pytestãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£
â”‚   â”œâ”€â”€ unit/                     # ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ
â”‚   â”‚   â”œâ”€â”€ test_task_service.py
â”‚   â”‚   â”œâ”€â”€ test_estimator_service.py
â”‚   â”‚   â””â”€â”€ test_safety_service.py
â”‚   â”œâ”€â”€ integration/              # çµ±åˆãƒ†ã‚¹ãƒˆ
â”‚   â”‚   â”œâ”€â”€ test_api_tasks.py
â”‚   â”‚   â””â”€â”€ test_database.py
â”‚   â””â”€â”€ e2e/                      # E2Eãƒ†ã‚¹ãƒˆ
â”‚       â””â”€â”€ test_full_workflow.py
â”‚
â”œâ”€â”€ .env                          # ç’°å¢ƒå¤‰æ•°
â”œâ”€â”€ .env.sample                   # ç’°å¢ƒå¤‰æ•°ã‚µãƒ³ãƒ—ãƒ«
â”œâ”€â”€ requirements.txt              # Pythonä¾å­˜é–¢ä¿‚
â”œâ”€â”€ pytest.ini                    # pytestè¨­å®š
â””â”€â”€ app.db                        # SQLiteãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
```

---

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### å¤šå±¤é˜²å¾¡

```mermaid
graph TB
    subgraph "Layer 1: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯"
        SSL[SSL/TLSæš—å·åŒ–<br/>Let's Encrypt]
        BasicAuth[Basicèªè¨¼<br/>.htpasswd]
    end

    subgraph "Layer 2: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³"
        CORS[CORSåˆ¶é™<br/>è¨±å¯ã‚ªãƒªã‚¸ãƒ³ã®ã¿]
        FileSizeLimit[ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºåˆ¶é™<br/>10MB]
        ResourceLimit[ãƒªã‚½ãƒ¼ã‚¹åˆ¶é™<br/>åŒæ™‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°]
    end

    subgraph "Layer 3: ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯"
        Safety[SafetyService<br/>Guardrails]
        InputValidation[å…¥åŠ›æ¤œè¨¼<br/>Pydantic]
        SQLInjection[SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–<br/>SQLAlchemy ORM]
    end

    subgraph "Layer 4: ãƒ‡ãƒ¼ã‚¿"
        EnvVars[ç’°å¢ƒå¤‰æ•°åˆ†é›¢<br/>.env]
        FilePermission[ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³<br/>600]
        DBIsolation[ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆ†é›¢<br/>ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨]
    end

    SSL --> CORS
    BasicAuth --> FileSizeLimit
    CORS --> Safety
    FileSizeLimit --> InputValidation
    ResourceLimit --> SQLInjection
    Safety --> EnvVars
    InputValidation --> FilePermission
    SQLInjection --> DBIsolation
```

### Guardrailså®Ÿè£…

```mermaid
graph LR
    Input[ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›] --> Safety[SafetyService]

    Safety --> PI[ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³æ¤œå‡º]
    Safety --> IC[ä¸é©åˆ‡ã‚³ãƒ³ãƒ†ãƒ³ãƒ„æ¤œå‡º]
    Safety --> LL[é•·ã•åˆ¶é™ãƒã‚§ãƒƒã‚¯]

    PI --> |æ¤œå‡º| Reject[HTTPException 400]
    IC --> |æ¤œå‡º| Reject
    LL --> |è¶…é| Reject

    PI --> |å®‰å…¨| Process[å‡¦ç†ç¶šè¡Œ]
    IC --> |å®‰å…¨| Process
    LL --> |å®‰å…¨| Process

    Process --> LLM[LLM APIå‘¼ã³å‡ºã—]
```

**å®Ÿè£…ç®‡æ‰€**:
- `app/services/safety_service.py`
- `app/api/v1/tasks.py` (create_task, chat)

---

## ãƒ¬ã‚¸ãƒªã‚¨ãƒ³ã‚¹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### CircuitBreaker ãƒ‘ã‚¿ãƒ¼ãƒ³

```mermaid
stateDiagram-v2
    [*] --> CLOSED: åˆæœŸçŠ¶æ…‹

    CLOSED --> OPEN: é€£ç¶š5å›å¤±æ•—
    OPEN --> HALF_OPEN: 60ç§’çµŒé
    HALF_OPEN --> CLOSED: æˆåŠŸ
    HALF_OPEN --> OPEN: å¤±æ•—

    CLOSED: CircuitBreaker CLOSED<br/>é€šå¸¸å‹•ä½œ<br/>- ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€šé<br/>- å¤±æ•—ã‚«ã‚¦ãƒ³ãƒˆ

    OPEN: CircuitBreaker OPEN<br/>å³åº§ã«å¤±æ•—<br/>- ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ–ãƒ­ãƒƒã‚¯<br/>- ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ

    HALF_OPEN: CircuitBreaker HALF_OPEN<br/>è©¦é¨“å‹•ä½œ<br/>- 1ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ã¿é€šé<br/>- æˆåŠŸã§å¾©æ—§ã€å¤±æ•—ã§OPEN
```

**è¨­å®š**:
- å¤±æ•—é–¾å€¤: 5å›
- ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: 60ç§’
- ãƒãƒ¼ãƒ•ã‚ªãƒ¼ãƒ—ãƒ³è©¦è¡Œå›æ•°: 1å›

**å®Ÿè£…**: `app/middleware/circuit_breaker.py`

### Retry ãƒ­ã‚¸ãƒƒã‚¯

```mermaid
graph TB
    Start[APIå‘¼ã³å‡ºã—é–‹å§‹] --> Try1[1å›ç›®è©¦è¡Œ]

    Try1 --> |æˆåŠŸ| Success[æˆåŠŸ]
    Try1 --> |å¤±æ•—| Wait1[1ç§’å¾…æ©Ÿ]

    Wait1 --> Try2[2å›ç›®è©¦è¡Œ]
    Try2 --> |æˆåŠŸ| Success
    Try2 --> |å¤±æ•—| Wait2[2ç§’å¾…æ©Ÿ<br/>Exponential Backoff]

    Wait2 --> Try3[3å›ç›®è©¦è¡Œ]
    Try3 --> |æˆåŠŸ| Success
    Try3 --> |å¤±æ•—| Failure[å¤±æ•—<br/>CircuitBreakerã¸è¨˜éŒ²]

    Success --> [*]
    Failure --> [*]
```

**è¨­å®š**:
- æœ€å¤§ãƒªãƒˆãƒ©ã‚¤å›æ•°: 3å›
- ãƒãƒƒã‚¯ã‚ªãƒ•æˆ¦ç•¥: Exponential (1ç§’, 2ç§’, 4ç§’)
- ãƒªãƒˆãƒ©ã‚¤å¯¾è±¡ã‚¨ãƒ©ãƒ¼: Timeout, RateLimitError, APIConnectionError

**å®Ÿè£…**: `app/utils/retry.py`

### Loop Detector

```mermaid
sequenceDiagram
    participant Client
    participant API
    participant LoopDetector
    participant Cache

    Client->>API: Request (prompt_hash)
    API->>LoopDetector: check_loop(task_id, prompt_hash)

    LoopDetector->>Cache: get(task_id)
    Cache-->>LoopDetector: history[]

    alt åŒã˜prompt_hashãŒ3å›ä»¥ä¸Š
        LoopDetector-->>API: LoopDetectedError
        API-->>Client: 400 Bad Request<br/>"ãƒ«ãƒ¼ãƒ—ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
    else æ­£å¸¸
        LoopDetector->>Cache: append(prompt_hash)
        LoopDetector-->>API: OK
        API->>API: å‡¦ç†ç¶šè¡Œ
    end
```

**è¨­å®š**:
- ãƒ«ãƒ¼ãƒ—æ¤œå‡ºé–¾å€¤: 3å›
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¿æŒæ™‚é–“: 1æ™‚é–“

**å®Ÿè£…**: `app/middleware/loop_detector.py`

### Resource Limiter

```mermaid
graph TB
    Request[ãƒªã‚¯ã‚¨ã‚¹ãƒˆå—ä¿¡] --> Check[åŒæ™‚å®Ÿè¡Œæ•°ãƒã‚§ãƒƒã‚¯]

    Check --> |< MAX_CONCURRENT| Acquire[ã‚»ãƒãƒ•ã‚©å–å¾—]
    Check --> |>= MAX_CONCURRENT| Wait[ã‚­ãƒ¥ãƒ¼ã§å¾…æ©Ÿ<br/>æœ€å¤§30ç§’]

    Wait --> |ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ| Reject[503 Service Unavailable]
    Wait --> |å–å¾—å¯èƒ½| Acquire

    Acquire --> Process[å‡¦ç†å®Ÿè¡Œ]
    Process --> Release[ã‚»ãƒãƒ•ã‚©è§£æ”¾]
    Release --> Response[ãƒ¬ã‚¹ãƒãƒ³ã‚¹è¿”å´]

    Reject --> [*]
    Response --> [*]
```

**è¨­å®š**:
- æœ€å¤§åŒæ™‚å®Ÿè¡Œæ•°: 5
- ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: 30ç§’

**å®Ÿè£…**: `app/middleware/resource_limiter.py`

---

## å¤šè¨€èªã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### ç¿»è¨³ã‚·ã‚¹ãƒ†ãƒ 

```mermaid
graph TB
    subgraph "ç’°å¢ƒå¤‰æ•°"
        ENV[.env<br/>LANGUAGE=ja/en]
    end

    subgraph "ç¿»è¨³ãƒ•ã‚¡ã‚¤ãƒ«"
        JA[locales/ja.json<br/>æ—¥æœ¬èªç¿»è¨³]
        EN[locales/en.json<br/>è‹±èªç¿»è¨³]
    end

    subgraph "ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³"
        I18N[i18n.py<br/>ç¿»è¨³ã‚¨ãƒ³ã‚¸ãƒ³]
        Services[Services<br/>ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯]
        Prompts[Prompts<br/>LLMãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ]
        API[API Endpoints]
    end

    subgraph "å‡ºåŠ›"
        UI[UIãƒ†ã‚­ã‚¹ãƒˆ]
        Excel[Excelå‡ºåŠ›]
        LLMOutput[LLMç”Ÿæˆã‚³ãƒ³ãƒ†ãƒ³ãƒ„]
    end

    ENV --> I18N
    JA --> I18N
    EN --> I18N

    I18N --> Services
    I18N --> Prompts
    I18N --> API

    Services --> UI
    Prompts --> LLMOutput
    API --> Excel
```

**ç¿»è¨³é–¢æ•°**:
```python
from app.core.i18n import t

# UIãƒ†ã‚­ã‚¹ãƒˆ
title = t('ui.app_title')

# LLMãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
language_instruction = t('prompts.language_instruction')

# Excelåˆ—å
column_name = t('excel.column_deliverable_name')
```

**ç¿»è¨³ãƒ•ã‚¡ã‚¤ãƒ«æ§‹é€ **:
```json
{
  "ui": { "app_title": "..." },
  "prompts": { "language_instruction": "..." },
  "excel": { "column_deliverable_name": "..." },
  "messages": { "error_message": "..." }
}
```

---

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### ä¸¦åˆ—å‡¦ç†

```mermaid
graph TB
    Start[è¦‹ç©ã‚Šé–‹å§‹] --> Split[æˆæœç‰©åˆ†å‰²]

    Split --> P1[æˆæœç‰©1<br/>LLM APIå‘¼ã³å‡ºã—]
    Split --> P2[æˆæœç‰©2<br/>LLM APIå‘¼ã³å‡ºã—]
    Split --> P3[æˆæœç‰©3<br/>LLM APIå‘¼ã³å‡ºã—]
    Split --> PN[æˆæœç‰©N<br/>LLM APIå‘¼ã³å‡ºã—]

    P1 --> |ThreadPoolExecutor| Join[çµæœçµ±åˆ]
    P2 --> |ThreadPoolExecutor| Join
    P3 --> |ThreadPoolExecutor| Join
    PN --> |ThreadPoolExecutor| Join

    Join --> Calculate[åˆè¨ˆé‡‘é¡è¨ˆç®—]
    Calculate --> Excel[Excelç”Ÿæˆ]
    Excel --> End[å®Œäº†]
```

**å®Ÿè£…**: `app/services/task_service.py`
- `ThreadPoolExecutor` ã§ä¸¦åˆ—å®Ÿè¡Œ
- æœ€å¤§ãƒ¯ãƒ¼ã‚«ãƒ¼æ•°: 10

### ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°

```mermaid
graph LR
    Request[ãƒªã‚¯ã‚¨ã‚¹ãƒˆ] --> CheckCache{ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç¢ºèª}

    CheckCache --> |HIT| CacheReturn[ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¿”å´]
    CheckCache --> |MISS| Process[å‡¦ç†å®Ÿè¡Œ]

    Process --> LLM[LLM APIå‘¼ã³å‡ºã—]
    LLM --> SaveCache[ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¿å­˜]
    SaveCache --> Return[çµæœè¿”å´]

    CacheReturn --> [*]
    Return --> [*]
```

**ã‚­ãƒ£ãƒƒã‚·ãƒ¥å¯¾è±¡**:
- è³ªå•ç”Ÿæˆçµæœï¼ˆã‚¿ã‚¹ã‚¯IDã”ã¨ï¼‰
- èª¿æ•´ææ¡ˆï¼ˆã‚¿ã‚¹ã‚¯ID + ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒãƒƒã‚·ãƒ¥ï¼‰

**TTL**: 1æ™‚é–“

---

## å‚è€ƒè³‡æ–™

- [DEPLOYMENT.md](../deployment/DEPLOYMENT.md) - ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã‚¬ã‚¤ãƒ‰
- [DEVELOPER_GUIDE.md](../development/DEVELOPER_GUIDE.md) - é–‹ç™ºè€…ã‚¬ã‚¤ãƒ‰
- [API_REFERENCE.md](../development/API_REFERENCE.md) - APIãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹
- [SECURITY_CHECKLIST.md](../security/SECURITY_CHECKLIST.md) - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

---

**æœ€çµ‚æ›´æ–°**: 2025-10-21
**ä½œæˆè€…**: Claude Code
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0
