<!doctype html>
<html lang="ja" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title data-i18n="ui.app_title">AI見積りシステム Web</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Markdown render + sanitize -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
  <!-- Charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              50: '#f8fafc', 100: '#eef2ff', 200: '#dbeafe', 300: '#bfdbfe',
              400: '#93c5fd', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8',
              800: '#0f172a', 900: '#0b1220'
            }
          }
        }
      }
    }
  </script>
  <style>
    .hidden { display:none; }
    /* テキストエリア/チャット入力は黒枠に */
    textarea,
    #chat-input { border:1px solid #000 !important; }
    @keyframes flashUp {
      0% { background-color: rgba(16,185,129,0.18); }
      50% { background-color: rgba(16,185,129,0.06); }
      100% { background-color: rgba(16,185,129,0.18); }
    }
    @keyframes flashDown {
      0% { background-color: rgba(244,63,94,0.18); }
      50% { background-color: rgba(244,63,94,0.06); }
      100% { background-color: rgba(244,63,94,0.18); }
    }
    .diff-up { animation: flashUp 0.9s ease-in-out 2; }
    .diff-down { animation: flashDown 0.9s ease-in-out 2; }
  </style>
  <script src="/static/i18n.js"></script>
  <script>
    const API_BASE = `${location.origin}`;
    let currentTaskId = null;

    function showSpinner(show) {
      const el = document.getElementById('spinner');
      if (show) el.classList.remove('hidden'); else el.classList.add('hidden');
    }

    function toast(message, type = 'info', opts = {}) {
      const { sticky = (type === 'error'), duration = (type === 'error' ? 12000 : 6000), details = '' } = opts;
      const wrap = document.getElementById('toasts');

      const t = document.createElement('div');
      const base = 'relative px-4 py-3 rounded shadow text-white mb-2 max-w-[92vw] md:max-w-[560px] break-words whitespace-pre-wrap transition-opacity';
      const bg = type === 'success' ? 'bg-emerald-600' : type === 'error' ? 'bg-rose-600' : 'bg-slate-800';
      t.className = `${base} ${bg}`;
      t.setAttribute('role', 'status');
      t.setAttribute('aria-live', 'polite');

      const title = document.createElement('div');
      title.textContent = message;
      t.appendChild(title);

      if (details && String(details).trim()) {
        const btnRow = document.createElement('div');
        btnRow.className = 'mt-2 flex gap-2 text-xs';

        const moreBtn = document.createElement('button');
        moreBtn.className = 'px-2 py-1 rounded bg-white/20 hover:bg-white/30';
        moreBtn.textContent = t('ui.button_details');

        const copyBtn = document.createElement('button');
        copyBtn.className = 'px-2 py-1 rounded bg-white/20 hover:bg-white/30';
        copyBtn.textContent = t('ui.button_copy');

        const pre = document.createElement('pre');
        pre.className = 'mt-2 max-h-64 overflow-auto text-white/90 text-[11px] border-t border-white/20 pt-2';
        pre.textContent = String(details).slice(0, 4000);
        pre.style.display = 'none';

        moreBtn.onclick = () => {
          pre.style.display = (pre.style.display === 'none') ? 'block' : 'none';
        };
        copyBtn.onclick = async () => {
          try { await navigator.clipboard.writeText(pre.textContent); moreBtn.textContent = t('ui.button_details'); } catch(e) {}
        };

        btnRow.appendChild(moreBtn);
        btnRow.appendChild(copyBtn);
        t.appendChild(btnRow);
        t.appendChild(pre);
      }

      const closeBtn = document.createElement('button');
      closeBtn.className = 'absolute top-1 right-2 text-white/80 hover:text-white';
      closeBtn.textContent = '×';
      closeBtn.onclick = () => t.remove();
      t.appendChild(closeBtn);

      wrap.appendChild(t);

      if (!sticky) {
        setTimeout(() => { t.classList.add('opacity-0'); }, Math.max(1000, duration - 600));
        setTimeout(() => { try { t.remove(); } catch(e) {} }, duration);
      }
    }

    let currentInputMode = 'excel';

    function switchTab(mode) {
      currentInputMode = mode;

      // タブボタンのスタイル更新
      ['excel', 'csv', 'form'].forEach(m => {
        const tab = document.getElementById(`tab-${m}`);
        const content = document.getElementById(`content-${m}`);

        if (m === mode) {
          tab.className = 'px-4 py-2 text-sm font-medium border-b-2 border-brand-600 text-brand-600';
          content.classList.remove('hidden');
        } else {
          tab.className = 'px-4 py-2 text-sm font-medium border-b-2 border-transparent text-slate-600 hover:text-slate-900';
          content.classList.add('hidden');
        }
      });
    }

    function addFormRow() {
      const tbody = document.getElementById('form-tbody');
      const row = document.createElement('tr');
      row.innerHTML = `
        <td class="py-2 px-2"><input type="text" class="w-full rounded border-slate-300 text-sm" placeholder="${t('ui.placeholder_deliverable_name')}" /></td>
        <td class="py-2 px-2"><input type="text" class="w-full rounded border-slate-300 text-sm" placeholder="${t('ui.placeholder_deliverable_desc')}" /></td>
        <td class="py-2 px-2 text-center"><button onclick="removeFormRow(this)" class="text-slate-400 hover:text-rose-600 text-xs">${t('ui.button_delete')}</button></td>
      `;
      tbody.appendChild(row);
    }

    function removeFormRow(btn) {
      const tbody = document.getElementById('form-tbody');
      if (tbody.querySelectorAll('tr').length > 1) {
        btn.closest('tr').remove();
      } else {
        toast(t('ui.error_min_one_row'), 'error');
      }
    }

    async function createTask() {
      const sysreq = document.getElementById('system_requirements').value;
      const fd = new FormData();
      fd.append('system_requirements', sysreq);

      showSpinner(true);

      try {
        // 入力モードに応じた処理
        if (currentInputMode === 'excel') {
          const f = document.getElementById('file-excel');
          if (!f.files[0]) { alert(t('ui.alert_select_excel')); showSpinner(false); return; }
          fd.append('file', f.files[0]);
        } else if (currentInputMode === 'csv') {
          const f = document.getElementById('file-csv');
          if (!f.files[0]) { alert(t('ui.alert_select_csv')); showSpinner(false); return; }
          fd.append('file', f.files[0]);
        } else if (currentInputMode === 'form') {
          // Webフォームからデータ収集
          const rows = document.querySelectorAll('#form-tbody tr');
          const deliverables = [];
          rows.forEach(row => {
            const inputs = row.querySelectorAll('input');
            const name = inputs[0].value.trim();
            const description = inputs[1].value.trim();
            if (name) {
              deliverables.push({ name, description });
            }
          });

          if (deliverables.length === 0) {
            alert(t('ui.error_no_deliverables'));
            showSpinner(false);
            return;
          }

          fd.append('deliverables_json', JSON.stringify(deliverables));
        }

        const res = await fetch(`${API_BASE}/api/v1/tasks`, { method: 'POST', body: fd, credentials:'include' });
        if (!res.ok) {
          const txt = await res.text().catch(()=> '');
          toast(t('ui.toast_task_create_failed'), 'error', { details: `${res.status} ${res.statusText}\n${txt}` });
          return;
        }
        const task = await res.json();
        currentTaskId = task.id;
        document.getElementById('taskId').textContent = task.id;
        document.getElementById('step-qa').classList.remove('hidden');
        await loadQuestions();
      } catch (e) {
        toast(t('ui.toast_task_create_failed'), 'error', { details: e?.message||String(e) });
      } finally { showSpinner(false); }
    }

    async function loadQuestions() {
      if (!currentTaskId) return;
      showSpinner(true);
      try {
        const res = await fetch(`${API_BASE}/api/v1/tasks/${currentTaskId}/questions`, { credentials:'include' });
        if (!res.ok) {
          const txt = await res.text().catch(()=> '');
          toast(t('ui.toast_question_load_failed'), 'error', { details: `${res.status} ${res.statusText}\n${txt}` });
          return;
        }
        const qs = await res.json();
        const container = document.getElementById('questions');
        container.innerHTML = '';
        qs.forEach((q, i) => {
          const wrap = document.createElement('div');
          wrap.className = 'rounded-lg border border-slate-200 p-4 bg-white';
          wrap.innerHTML = `
            <div class="text-sm text-slate-500 mb-1">${t('ui.label_question')}${i+1}</div>
            <div class="text-slate-800 font-medium mb-3">${q}</div>
            <label class="text-slate-600 text-sm">${t('ui.label_answer')}</label>
            <textarea rows="2" data-qa-index="${i}" data-question="${q.replace(/"/g,'&quot;')}"
              class="mt-1 w-full rounded border-slate-300 focus:border-brand-500 focus:ring-brand-500"></textarea>
          `;
          container.appendChild(wrap);
        });
      } catch (e) {
        toast(t('ui.toast_question_load_failed'), 'error', { details: e?.message||String(e) });
      } finally { showSpinner(false); }
    }

    async function submitAnswers() {
      if (!currentTaskId) return;
      const areas = document.querySelectorAll('#questions textarea');
      const qa_pairs = Array.from(areas).map((ta) => ({
        question: ta.dataset.question || '',
        answer: ta.value || ''
      }));
      showSpinner(true);
      try {
        // 同期処理: 返答が来るまでスピナー表示
        const res = await fetch(`${API_BASE}/api/v1/tasks/${currentTaskId}/answers`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(qa_pairs), credentials:'include'
        });
        if (!res.ok) {
          const txt = await res.text().catch(()=> '');
          toast(t('ui.toast_estimate_execute_failed'), 'error', { details: `${res.status} ${res.statusText}\n${txt}` });
          return;
        }
        await loadResult();
      } catch (e) {
        toast(t('ui.toast_estimate_execute_failed'), 'error', { details: e?.message||String(e) });
      } finally { showSpinner(false); }
    }

    async function loadResult() {
      if (!currentTaskId) return;
      const res = await fetch(`${API_BASE}/api/v1/tasks/${currentTaskId}/result`, { credentials:'include' });
      if (!res.ok) { alert(t('ui.alert_result_load_failed') + (await res.text())); return; }
      const data = await res.json();

      // 合計情報を更新
      document.getElementById('subtotal').textContent = Math.round(data.subtotal).toLocaleString();
      document.getElementById('tax').textContent = Math.round(data.tax).toLocaleString();
      document.getElementById('total').textContent = Math.round(data.total).toLocaleString();

      // アコーディオン形式で見積り詳細を表示
      const accordion = document.getElementById('result-accordion');
      accordion.innerHTML = '';

      data.estimates.forEach((item, index) => {
        const name = item.deliverable_name || item.name || '';
        const desc = item.deliverable_description || item.description || '';
        const pd = Number(item.person_days || 0).toFixed(1);
        const amt = Math.round(item.amount || 0).toLocaleString();
        const breakdown = (item.reasoning_breakdown || item.reasoning || "").toString();
        const notes = (item.reasoning_notes || "").toString();
        const htmlBreakdown = DOMPurify.sanitize(marked.parse(breakdown));
        const htmlNotes = DOMPurify.sanitize(marked.parse(notes));

        const accordionItem = document.createElement('div');
        accordionItem.className = 'rounded-lg border border-slate-200 bg-white overflow-hidden';
        accordionItem.dataset.accordionIndex = index;

        accordionItem.innerHTML = `
          <button class="w-full px-4 py-3 flex items-center justify-between hover:bg-slate-50 transition-colors" onclick="toggleAccordion(${index})">
            <div class="flex-1 text-left">
              <div class="flex items-center gap-3">
                <div class="font-medium text-slate-900">${name}</div>
                <div class="text-sm text-slate-600">${desc}</div>
              </div>
            </div>
            <div class="flex items-center gap-4 text-sm">
              <div class="text-right">
                <div class="text-slate-500 text-xs">工数</div>
                <div class="font-semibold tabular-nums">${pd}人日</div>
              </div>
              <div class="text-right">
                <div class="text-slate-500 text-xs">金額</div>
                <div class="font-semibold tabular-nums">${amt}円</div>
              </div>
              <svg class="w-5 h-5 text-slate-400 transition-transform duration-200 accordion-icon-${index}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </div>
          </button>
          <div class="accordion-content-${index} hidden px-4 py-3 border-t border-slate-200 bg-slate-50">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <div class="text-sm font-semibold text-slate-900 mb-2">工数内訳</div>
                <div class="text-sm text-slate-700 prose prose-slate max-w-none">${htmlBreakdown}</div>
              </div>
              <div>
                <div class="text-sm font-semibold text-slate-900 mb-2">根拠・備考</div>
                <div class="text-sm text-slate-700 prose prose-slate max-w-none">${htmlNotes}</div>
              </div>
            </div>
          </div>
        `;

        accordion.appendChild(accordionItem);
      });

      // ダウンロードボタンを有効化
      const dlBtn = document.getElementById('downloadBtn');
      if (dlBtn) { dlBtn.disabled = false; dlBtn.classList.remove('opacity-50','pointer-events-none'); }

      // 結果セクションを表示
      document.getElementById('step-result').classList.remove('hidden');
      toast(t('ui.message_estimate_completed'), 'success');

      // チャートを描画
      renderChart(data.estimates);

      // 見積りデータを保存
      window.initialEstimates = JSON.parse(JSON.stringify(data.estimates||[]));
      window.lastEstimates = JSON.parse(JSON.stringify(data.estimates||[]));

      // 見積り調整エリアを表示
      const adjust = document.getElementById('adjust');
      if (adjust) adjust.classList.remove('hidden');
    }

    // アコーディオンの開閉制御
    function toggleAccordion(index) {
      const content = document.querySelector(`.accordion-content-${index}`);
      const icon = document.querySelector(`.accordion-icon-${index}`);

      if (content.classList.contains('hidden')) {
        content.classList.remove('hidden');
        icon.style.transform = 'rotate(180deg)';
      } else {
        content.classList.add('hidden');
        icon.style.transform = 'rotate(0deg)';
      }
    }

    // 全アコーディオンの開閉制御
    function toggleAllAccordions(open) {
      const accordion = document.getElementById('result-accordion');
      if (!accordion) return;

      const items = accordion.querySelectorAll('[data-accordion-index]');
      items.forEach((item, index) => {
        const content = document.querySelector(`.accordion-content-${index}`);
        const icon = document.querySelector(`.accordion-icon-${index}`);

        if (open) {
          content?.classList.remove('hidden');
          if (icon) icon.style.transform = 'rotate(180deg)';
        } else {
          content?.classList.add('hidden');
          if (icon) icon.style.transform = 'rotate(0deg)';
        }
      });
    }

    // --- Chart ---
    let estChart = null;
    function renderChart(estimates, prevEstimates=null) {
      try {
        const ctx = document.getElementById('est-chart').getContext('2d');
        const labels = estimates.map(e => e.deliverable_name || e.name || '');
        const amountsNew = estimates.map(e => Math.round(e.amount || 0));
        if (!estChart) {
          const bg = labels.map((_, i) => `hsl(${(i*57)%360} 70% 60%)`);
          estChart = new Chart(ctx, {
            type: 'bar',
            data: { labels: labels.slice(), datasets: [{ label: '金額(円)', data: amountsNew.slice(), backgroundColor: bg }] },
            options: {
              responsive: true,
              animation: { duration: 400, easing: 'easeOutCubic' },
              plugins: { legend: { display: false } },
              scales: { y: { ticks: { callback: v => v.toLocaleString() } } }
            }
          });
          return;
        }
        // Update labels
        estChart.data.labels = labels.slice();
        const amountsOldBase = (estChart.data.datasets[0].data || []).map(v => Number(v)||0);
        const changed = new Set();
        amountsNew.forEach((v,i)=>{ if ((amountsOldBase[i]||0) !== v) changed.add(i); });
        const frames = [0.85, 1.12, 1.0];
        const stepDur = 220;
        frames.forEach((f, idx) => {
          setTimeout(() => {
            const next = amountsNew.map((nv, i) => {
              const ov = amountsOldBase[i] || 0;
              if (!changed.has(i)) return nv;
              const target = ov + (nv - ov) * f;
              return Math.max(0, Math.round(target));
            });
            estChart.data.datasets[0].data = next;
            estChart.options.animation = { duration: stepDur, easing: 'easeOutCubic' };
            estChart.update();
          }, idx * (stepDur + 60));
        });
      } catch (e) { /* noop */ }
    }

    // --- Quick actions / Chat ---
    function parseNumberLike(s, allowFloat=false) {
      if (s == null) return NaN;
      const t = String(s).replace(/[,￥円\s]/g, '').replace('%','');
      const n = allowFloat ? parseFloat(t) : parseInt(t, 10);
      return isNaN(n) ? NaN : n;
    }
    async function quickAction(intent, params) {
      if (!currentTaskId) return;
      function parseNumberLike(s, allowFloat=false){ if(s==null) return NaN; const txt=String(s).replace(/[,￥円\s]/g,'').replace('%',''); const n=allowFloat?parseFloat(txt):parseInt(txt,10); return isNaN(n)?NaN:n; }
      if (intent === 'fit_budget') { const raw=document.getElementById('qa-cap').value; const cap=parseNumberLike(raw,false); if(!cap||cap<=0){ toast(t('ui.toast_enter_budget_cap'),'error'); return;} params={cap}; } else if (intent==='unit_cost_change'){ const raw=document.getElementById('qa-unit').value; const unit_cost=parseNumberLike(raw,false); if(!unit_cost||unit_cost<=0){ toast(t('ui.toast_enter_unit_cost'),'error'); return;} params={unit_cost}; } else if (intent==='risk_buffer'){ const raw=document.getElementById('qa-risk').value; const percent=parseNumberLike(raw,true); if(isNaN(percent)){ toast(t('ui.toast_enter_risk_percent'),'error'); return;} params={percent}; }
      if (!currentTaskId) return;
      // sanitize known params
      if (intent === 'fit_budget') {
        const raw = document.getElementById('qa-cap').value;
        const cap = parseNumberLike(raw, false);
        if (!cap || cap <= 0) { toast('上限金額を正しく入力してください', 'error'); return; }
        params = { cap };
      } else if (intent === 'unit_cost_change') {
        const raw = document.getElementById('qa-unit').value;
        const unit_cost = parseNumberLike(raw, false);
        if (!unit_cost || unit_cost <= 0) { toast('単価を正しく入力してください', 'error'); return; }
        params = { unit_cost };
      } else if (intent === 'risk_buffer') {
        const raw = document.getElementById('qa-risk').value;
        const percent = parseNumberLike(raw, true);
        if (isNaN(percent)) { toast('リスク%を正しく入力してください', 'error'); return; }
        params = { percent };
      }
      showSpinner(true);
      try {
        console.log('[UI] quickAction start', { intent, params, taskId: currentTaskId });
        const res = await fetch(`${API_BASE}/api/v1/tasks/${currentTaskId}/chat`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ intent, params, estimates: (window.lastEstimates||[]) }), credentials:'include'
        });
        if (!res.ok) {
          const txt = await res.text().catch(()=> '');
          toast(t('ui.toast_estimate_adjust_failed'), 'error', { details: `${res.status} ${res.statusText}\n${txt}` });
          return;
        }
        const data = await res.json();
        console.log('[UI] quickAction ok', { estimates: (data&&data.estimates)? data.estimates.length: 0 });
        try {
          const rep = document.getElementById('chat-reply');
          if (rep && data && data.reply_md) {
            rep.innerHTML = DOMPurify.sanitize(marked.parse(String(data.reply_md)));
          }
        } catch(_){}
        updateEstimatesView(data);
        if (data && data.suggestions) renderSuggestions(data.suggestions);
        toast(t('ui.toast_estimate_adjusted'), 'success');
      } catch (e) { toast(t('ui.toast_estimate_adjust_failed'), 'error', { details: e?.message||String(e) }); }
      finally { showSpinner(false); }
    }

    async function sendChat() {
      if (!currentTaskId) return;
      const msg = document.getElementById('chat-input').value.trim();
      if (!msg) { toast(t('ui.toast_enter_message'), 'error'); return; }
      showSpinner(true);
      try {
        console.log('[UI] sendChat start', { taskId: currentTaskId, msg });
        const res = await fetch(`${API_BASE}/api/v1/tasks/${currentTaskId}/chat`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: msg, estimates: (window.lastEstimates||[]) }), credentials:'include'
        });
        if (!res.ok) {
          const txt = await res.text().catch(()=> '');
          toast(t('ui.toast_send_failed'), 'error', { details: `${res.status} ${res.statusText}\n${txt}` });
          return;
        }
        const data = await res.json();
        console.log('[UI] sendChat ok', { estimates: (data&&data.estimates)? data.estimates.length: 0, proposals: data?.proposals?.length || 0 });

        // AIからの返信メッセージを表示
        try {
          const rep = document.getElementById('chat-reply');
          if (rep && data && data.reply_md) {
            rep.innerHTML = DOMPurify.sanitize(marked.parse(String(data.reply_md)));
          }
        } catch(_){}

        // 提案がある場合は提案カードを表示（見積は更新しない）
        if (data && data.proposals && data.proposals.length > 0) {
          renderProposals(data.proposals);
          // 見積は更新せず、提案選択を待つ
        } else {
          // 提案がない場合は通常の見積更新
          updateEstimatesView(data, true);
        }

        if (data && data.suggestions) renderSuggestions(data.suggestions);
        document.getElementById('chat-input').value='';
      } catch (e) { toast(t('ui.toast_send_failed'), 'error', { details: e?.message||String(e) }); }
      finally { showSpinner(false); }
    }

    function renderProposals(proposals) {
      try {
        const container = document.getElementById('chat-proposals');
        if (!container) return;

        container.innerHTML = '';

        (proposals || []).forEach((proposal, index) => {
          const proposalCard = document.createElement('div');
          proposalCard.className = 'border border-slate-300 rounded-lg p-4 bg-white hover:shadow-md transition-shadow';

          // 金額変化の方向を判定
          const amountChange = proposal.target_amount_change || 0;
          const isReduction = amountChange < 0;
          const amountClass = isReduction ? 'text-emerald-600' : 'text-blue-600';
          const amountLabel = isReduction ? '削減額' : '増額';
          const amountDisplay = Math.abs(amountChange).toLocaleString();

          // 変更内容のHTML生成
          let changesHtml = '';
          if (proposal.changes && proposal.changes.length > 0) {
            changesHtml = '<ul class="list-disc list-inside space-y-1 text-sm text-slate-700">';
            proposal.changes.forEach(change => {
              const pdBefore = Number(change.person_days_before || 0).toFixed(1);
              const pdAfter = Number(change.person_days_after || 0).toFixed(1);
              const amtBefore = Math.round(change.amount_before || 0).toLocaleString();
              const amtAfter = Math.round(change.amount_after || 0).toLocaleString();
              const reasoning = change.reasoning || '';

              changesHtml += `<li><span class="font-medium">${change.deliverable_name || ''}</span>: ${pdBefore}人日 → ${pdAfter}人日 (${amtBefore}円 → ${amtAfter}円)`;
              if (reasoning) {
                changesHtml += `<br><span class="text-xs text-slate-500 ml-6">${reasoning}</span>`;
              }
              changesHtml += '</li>';
            });
            changesHtml += '</ul>';
          }

          proposalCard.innerHTML = `
            <div class="flex items-start justify-between mb-3">
              <div>
                <div class="font-semibold text-slate-900 mb-1">【案${index + 1}】${proposal.title || ''}</div>
                <div class="text-sm ${amountClass} font-medium">${amountLabel}: ${amountDisplay}円</div>
              </div>
            </div>
            ${proposal.description ? `<div class="text-sm text-slate-600 mb-3">${proposal.description}</div>` : ''}
            <div class="mb-4">
              <div class="text-xs font-semibold text-slate-700 mb-2">変更内容:</div>
              ${changesHtml}
            </div>
            <button
              onclick="applyProposal('${proposal.id || ''}')"
              class="w-full px-4 py-2 text-sm rounded ${isReduction ? 'bg-emerald-600 hover:bg-emerald-700' : 'bg-blue-600 hover:bg-blue-700'} text-white font-medium transition-colors"
            >
              この案を適用する
            </button>
          `;

          container.appendChild(proposalCard);
        });

        console.log(`[UI] renderProposals: ${proposals.length} proposals displayed`);
      } catch (e) {
        console.error('[UI] renderProposals error:', e);
        toast(t('ui.toast_proposal_display_failed'), 'error', { details: e?.message || String(e) });
      }
    }

    async function applyProposal(proposalId) {
      if (!currentTaskId) return;
      if (!proposalId) {
        toast(t('ui.toast_invalid_proposal_id'), 'error');
        return;
      }

      // 確認ダイアログ
      if (!confirm(t('ui.alert_confirm_apply_proposal'))) {
        return;
      }

      showSpinner(true);
      try {
        console.log('[UI] applyProposal start', { proposalId, taskId: currentTaskId });

        const res = await fetch(`${API_BASE}/api/v1/tasks/${currentTaskId}/chat`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            intent: 'apply_proposal',
            params: { proposal_id: proposalId },
            estimates: (window.lastEstimates || [])
          }),
          credentials: 'include'
        });

        if (!res.ok) {
          const txt = await res.text().catch(() => '');
          toast(t('ui.toast_proposal_apply_failed'), 'error', { details: `${res.status} ${res.statusText}\n${txt}` });
          return;
        }

        const data = await res.json();
        console.log('[UI] applyProposal ok', { estimates: (data && data.estimates) ? data.estimates.length : 0 });

        // 提案カードをクリア
        const container = document.getElementById('chat-proposals');
        if (container) container.innerHTML = '';

        // 見積を更新
        updateEstimatesView(data, true);

        toast(t('ui.message_proposal_applied'), 'success');
      } catch (e) {
        console.error('[UI] applyProposal error:', e);
        toast(t('ui.toast_proposal_apply_failed'), 'error', { details: e?.message || String(e) });
      } finally {
        showSpinner(false);
      }
    }

    function renderSuggestions(suggestions){
      try {
        const wrap = document.getElementById('chat-suggestions');
        if (!wrap) return;
        wrap.innerHTML='';
        (suggestions||[]).forEach(s => {
          const btn = document.createElement('button');
          btn.className = 'px-2 py-1 text-xs rounded border border-slate-300 hover:bg-slate-100';
          btn.textContent = s.label || '提案';
          btn.onclick = () => runSuggestion(s.payload||{});
          wrap.appendChild(btn);
        });
      } catch(e) {}
    }

    async function runSuggestion(payload){
      try {
        if (payload.intent) {
          await quickAction(payload.intent, payload.params||{});
          return;
        }
        if (payload.message) {
          const input = document.getElementById('chat-input');
          input.value = payload.message;
          await sendChat();
          return;
        }
      } catch(e) { toast(t('ui.toast_proposal_run_failed'), 'error', { details: e?.message||String(e) }); }
    }

    // duplicate updateEstimatesView removed (using enhanced version later)


    async function applyAdjustments() {
      if (!currentTaskId) return;
      const ests = window.lastEstimates;
      if (!ests || !ests.length) { toast(t('ui.toast_estimate_adjust_failed'), 'error'); return; }
      showSpinner(true);
      try {
        const res = await fetch(`${API_BASE}/api/v1/tasks/${currentTaskId}/apply`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ estimates: ests }), credentials:'include'
        });
        if (!res.ok) throw new Error(await res.text());
        const data = await res.json();
        updateEstimatesView(data);
        toast(t('ui.toast_apply_success'), 'success');
      } catch (e) { toast(t('ui.toast_apply_failed'), 'error'); }
      finally { showSpinner(false); }
    }
  </script>
</head>
<body class="h-full bg-slate-50">
  <div id="toasts" class="fixed right-4 top-4 z-[10000] flex flex-col"></div>
  <header class="bg-white border-b border-slate-200">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-md bg-brand-600 flex items-center justify-center text-white font-bold">AI</div>
        <div class="text-slate-900 font-semibold" data-i18n="ui.app_title">AI見積りシステム</div>
      </div>
      <div class="hidden sm:block text-slate-500 text-sm" data-i18n="ui.app_subtitle">Excelからプロ品質の見積を自動生成</div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-8">
    <section class="mb-6">
      <div class="rounded-xl bg-gradient-to-r from-brand-800 to-brand-600 text-white p-6">
        <h1 class="text-2xl sm:text-3xl font-semibold mb-2" data-i18n="ui.hero_title">見積り作成を、もっと速く正確に。</h1>
        <p class="text-white/90" data-i18n="ui.hero_description">Excelの成果物リストをアップロードし、質問に答えるだけ。AIが工数と金額を提示します。</p>
      </div>
    </section>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <section id="step-upload" class="rounded-xl border border-slate-200 bg-white p-5">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg font-semibold text-slate-900" data-i18n="ui.step1_title">1. 成果物データを入力</h2>
          <span class="text-xs text-slate-500"><span data-i18n="ui.label_task_id">タスクID:</span> <span id="taskId">-</span></span>
        </div>

        <!-- タブ切り替えUI -->
        <div class="flex border-b border-slate-200 mb-4">
          <button id="tab-excel" onclick="switchTab('excel')" class="px-4 py-2 text-sm font-medium border-b-2 border-brand-600 text-brand-600" data-i18n="ui.tab_excel">Excel</button>
          <button id="tab-csv" onclick="switchTab('csv')" class="px-4 py-2 text-sm font-medium border-b-2 border-transparent text-slate-600 hover:text-slate-900" data-i18n="ui.tab_csv">CSV</button>
          <button id="tab-form" onclick="switchTab('form')" class="px-4 py-2 text-sm font-medium border-b-2 border-transparent text-slate-600 hover:text-slate-900" data-i18n="ui.tab_form">Webフォーム</button>
        </div>

        <!-- Excelタブ -->
        <div id="content-excel" class="space-y-4">
          <div>
            <label class="text-sm text-slate-700" data-i18n="ui.label_excel_file">Excelファイル（.xlsx/.xls）</label>
            <input id="file-excel" type="file" accept=".xlsx,.xls" class="mt-1 block w-full text-sm text-slate-600 file:mr-3 file:py-2 file:px-3 file:rounded-md file:border-0 file:text-sm file:font-medium file:bg-brand-600 file:text-white hover:file:bg-brand-700" />
            <div class="mt-2">
              <a href="/api/v1/sample-input" download class="text-xs text-brand-600 hover:underline" data-i18n="ui.button_download_sample">サンプルExcelをダウンロード</a>
            </div>
          </div>
        </div>

        <!-- CSVタブ -->
        <div id="content-csv" class="space-y-4 hidden">
          <div>
            <label class="text-sm text-slate-700" data-i18n="ui.label_csv_file">CSVファイル（.csv）</label>
            <input id="file-csv" type="file" accept=".csv" class="mt-1 block w-full text-sm text-slate-600 file:mr-3 file:py-2 file:px-3 file:rounded-md file:border-0 file:text-sm file:font-medium file:bg-brand-600 file:text-white hover:file:bg-brand-700" />
            <div class="mt-2">
              <a href="/api/v1/sample-input-csv" download class="text-xs text-brand-600 hover:underline" data-i18n="ui.button_download_sample_csv">サンプルCSVをダウンロード</a>
            </div>
          </div>
        </div>

        <!-- Webフォームタブ -->
        <div id="content-form" class="space-y-4 hidden">
          <div class="border border-slate-200 rounded-lg p-3">
            <table class="w-full text-sm" id="form-table">
              <thead>
                <tr class="border-b border-slate-200">
                  <th class="text-left py-2 px-2 font-medium text-slate-700" data-i18n="ui.label_deliverable_name">成果物名称</th>
                  <th class="text-left py-2 px-2 font-medium text-slate-700" data-i18n="ui.label_deliverable_desc">説明</th>
                  <th class="w-16"></th>
                </tr>
              </thead>
              <tbody id="form-tbody">
                <tr>
                  <td class="py-2 px-2"><input type="text" class="w-full rounded border-slate-300 text-sm" data-i18n-placeholder="ui.placeholder_deliverable_name" placeholder="例: 要件定義書" /></td>
                  <td class="py-2 px-2"><input type="text" class="w-full rounded border-slate-300 text-sm" data-i18n-placeholder="ui.placeholder_deliverable_desc" placeholder="例: システム全体の要件定義" /></td>
                  <td class="py-2 px-2 text-center"><button onclick="removeFormRow(this)" class="text-slate-400 hover:text-rose-600 text-xs" data-i18n="ui.button_delete">削除</button></td>
                </tr>
              </tbody>
            </table>
            <div class="mt-3">
              <button onclick="addFormRow()" class="text-sm text-brand-600 hover:text-brand-700 font-medium" data-i18n="ui.button_add_deliverable">+ 成果物を追加</button>
            </div>
          </div>
        </div>

        <!-- システム要件（共通） -->
        <div class="mt-4 space-y-4">
          <div>
            <label class="text-sm text-slate-700" data-i18n="ui.label_system_requirements">システム要件（任意）</label>
            <textarea id="system_requirements" rows="4" class="mt-1 w-full rounded border-slate-300 focus:border-brand-500 focus:ring-brand-500" data-i18n-placeholder="ui.placeholder_system_requirements" placeholder="例: Webシステム。最大同時100接続、AWS(ECS/RDS)、Salesforce連携など"></textarea>
          </div>
          <div class="flex items-center gap-3">
            <button onclick="createTask()" class="inline-flex items-center bg-brand-600 hover:bg-brand-700 text-white rounded-md px-4 py-2 text-sm font-medium" data-i18n="ui.button_create_task">タスク作成</button>
            <span class="text-xs text-slate-500" data-i18n="ui.hint_auto_generate_questions">アップロード後、自動で質問を生成します</span>
          </div>
        </div>
      </section>

      <section id="step-qa" class="rounded-xl border border-slate-200 bg-white p-5 hidden">
        <h2 class="text-lg font-semibold text-slate-900 mb-3" data-i18n="ui.step2_title">2. 質問に回答</h2>
        <div id="questions" class="space-y-3"></div>
        <div class="mt-4">
          <button onclick="submitAnswers()" class="inline-flex items-center bg-brand-600 hover:bg-brand-700 text-white rounded-md px-4 py-2 text-sm font-medium" data-i18n="ui.button_submit_answers">見積りを実行</button>
        </div>
      </section>
    </div>

    <section id="step-result" class="rounded-xl border border-slate-200 bg-white p-5 mt-6 hidden">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-semibold text-slate-900" data-i18n="ui.step3_title">3. 見積り結果</h2>
        <button id="downloadBtn" class="inline-flex items-center bg-slate-900 hover:bg-slate-800 text-white rounded-md px-3 py-2 text-xs font-medium" onclick="downloadExcel()" data-i18n="ui.button_download">Excelをダウンロード</button>
      </div>

      <!-- 合計情報 -->
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-6">
        <div class="rounded-lg border border-slate-200 p-3 bg-slate-50">
          <div class="text-xs text-slate-500" data-i18n="ui.label_subtotal">小計</div>
          <div class="text-lg font-semibold tabular-nums" id="subtotal">-</div>
        </div>
        <div class="rounded-lg border border-slate-200 p-3 bg-slate-50">
          <div class="text-xs text-slate-500" data-i18n="ui.label_tax">税額(10%)</div>
          <div class="text-lg font-semibold tabular-nums" id="tax">-</div>
        </div>
        <div class="rounded-lg border border-slate-200 p-3 bg-slate-50">
          <div class="text-xs text-slate-500" data-i18n="ui.label_total">総額</div>
          <div class="text-lg font-semibold tabular-nums" id="total">-</div>
        </div>
      </div>

      <!-- 棒グラフ -->
      <div class="mb-6">
        <canvas id="est-chart" height="120"></canvas>
      </div>

      <!-- 見積り調整 -->
      <div id="adjust" class="mb-6 pb-6 border-b border-slate-200">
        <h3 class="text-base font-semibold text-slate-900 mb-3" data-i18n="ui.label_adjust_title">見積り調整</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="space-y-3">
            <div class="text-sm font-semibold text-slate-800 mb-1" data-i18n="ui.label_quick_adjust">クイック見積調整（機械的適用）</div>
            <div class="text-xs text-slate-500 -mt-2 mb-2" data-i18n="ui.hint_quick_adjust_description">現在表示中の見積を前提に、上限予算・単価・リスク・機能除外を連続適用します。</div>
            <div class="flex items-center gap-2">
              <input id="qa-cap" type="number" data-i18n-placeholder="ui.placeholder_budget_cap_input" placeholder="上限金額（円）" class="w-40 rounded border-slate-300" />
              <button class="px-3 py-2 text-sm rounded bg-slate-900 text-white" onclick="quickAction('fit_budget',{cap:Number(document.getElementById('qa-cap').value||0)})" data-i18n="ui.button_fit_budget">上限予算に合わせる</button>
            </div>
            <div class="flex items-center gap-2">
              <input id="qa-unit" type="number" data-i18n-placeholder="ui.placeholder_unit_cost_input" placeholder="単価（円/人日）" class="w-40 rounded border-slate-300" />
              <button class="px-3 py-2 text-sm rounded bg-slate-900 text-white" onclick="quickAction('unit_cost_change',{unit_cost:Number(document.getElementById('qa-unit').value||40000)})" data-i18n="ui.button_change_unit_cost">単価を変更</button>
            </div>
            <div class="flex items-center gap-2">
              <input id="qa-risk" type="number" data-i18n-placeholder="ui.placeholder_risk_percent_input" placeholder="リスク%" class="w-32 rounded border-slate-300" />
              <button class="px-3 py-2 text-sm rounded bg-slate-900 text-white" onclick="quickAction('risk_buffer',{percent:Number(document.getElementById('qa-risk').value||10)})" data-i18n="ui.button_add_risk_buffer">リスクバッファ追加</button>
            </div>
            <div class="flex items-center gap-2">
              <input id="qa-scope" type="text" data-i18n-placeholder="ui.placeholder_scope_keywords_input" placeholder="除外キーワード（,区切り）" class="w-80 rounded border-slate-300" />
              <button class="px-3 py-2 text-sm rounded bg-slate-900 text-white" onclick="quickAction('scope_reduce',{keywords:(document.getElementById('qa-scope').value||'').split(',')})" data-i18n="ui.button_reduce_scope">機能を絞る</button>
            </div>
          </div>
          <div>
            <div class="text-sm font-semibold text-slate-800 mb-1" data-i18n="ui.label_ai_adjust">AI見積調整（自由入力）</div>
            <div class="text-xs text-slate-500 -mt-2 mb-2" data-i18n="ui.hint_ai_adjust_description">金額調整の例：「あと30万円ほど安くする案を教えて」「予算があるので100万円アップする案を教えてほしい」</div>
            <div class="flex gap-2">
              <input id="chat-input" class="flex-1 rounded border-slate-300" data-i18n-placeholder="ui.placeholder_chat_input" placeholder="例: あと30万円ほど安くする案を教えて" />
              <button class="px-3 py-2 text-sm rounded bg-brand-600 text-white" onclick="sendChat()" data-i18n="ui.button_send">送信</button>
            </div>
            <div id="chat-suggestions" class="mt-3 flex flex-wrap gap-2"></div>
            <div id="chat-reply" class="mt-3 text-sm text-slate-700 prose prose-slate max-w-none"></div>
            <div id="chat-proposals" class="mt-4 space-y-3"></div>
          </div>
          <div class="mt-4">
            <button class="px-4 py-2 text-sm rounded bg-emerald-600 text-white" onclick="applyAdjustments()" data-i18n="ui.button_apply">調整案を反映（Excel再出力）</button>
            <button class="px-4 py-2 text-sm rounded bg-slate-200 text-slate-800" onclick="(function(){ if(!window.initialEstimates){ toast(t('ui.toast_initial_estimate_not_found'),'error'); return;} const data={ estimates: JSON.parse(JSON.stringify(window.initialEstimates)) }; updateEstimatesView(data); toast(t('ui.toast_reset_success'),'success'); })()" data-i18n="ui.button_reset">最初の見積内容に戻す</button>
          </div>
        </div>
      </div>

      <!-- アコーディオン制御ボタン -->
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-base font-semibold text-slate-900" data-i18n="ui.label_deliverable_details">成果物別詳細</h3>
        <div class="flex gap-2">
          <button onclick="toggleAllAccordions(true)" class="px-3 py-1 text-xs rounded border border-slate-300 hover:bg-slate-100" data-i18n="ui.button_expand_all">全て開く</button>
          <button onclick="toggleAllAccordions(false)" class="px-3 py-1 text-xs rounded border border-slate-300 hover:bg-slate-100" data-i18n="ui.button_collapse_all">全て閉じる</button>
        </div>
      </div>

      <!-- アコーディオン形式の見積り詳細 -->
      <div id="result-accordion" class="space-y-2"></div>

      <!-- モバイル用カード（非表示） -->
      <div id="result-cards" class="hidden"></div>
    </section>
  </main>

  <div id="spinner" class="hidden fixed inset-0 z-[9999] bg-white/70 backdrop-blur-sm flex items-center justify-center">
    <div class="flex items-center gap-3">
      <svg class="animate-spin h-6 w-6 text-brand-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
      </svg>
      <div class="text-slate-700 text-sm" data-i18n="ui.loading_estimate_in_progress">AIが見積りを作成しています…（1分前後）</div>
    </div>
  </div>
  <script>
    // Global error handlers to surface JS errors in UI
    window.addEventListener('error', (ev) => {
      try { toast(t('ui.toast_script_error'), 'error', { details: `${ev.message}\n${ev.filename}:${ev.lineno}:${ev.colno}` }); } catch(_) {}
    });
    window.addEventListener('unhandledrejection', (ev) => {
      try { const msg = (ev.reason && (ev.reason.stack||ev.reason.message)) || String(ev.reason);
        toast(t('ui.toast_unhandled_error'), 'error', { details: msg }); } catch(_) {}
    });
    async function downloadExcel(){
      try {
        if (!currentTaskId) { toast(t('ui.toast_task_not_created'), 'error'); return; }
        const url = `${API_BASE}/api/v1/tasks/${currentTaskId}/download`;
        const res = await fetch(url, { credentials:'include' });
        if(!res.ok) { const txt=await res.text().catch(()=> ''); throw new Error(`${res.status} ${res.statusText}\n${txt}`); }
        const blob = await res.blob();
        const a = document.createElement('a');
        const objectUrl = URL.createObjectURL(blob);
        a.href = objectUrl;
        a.download = `estimate_${Date.now()}.xlsx`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(objectUrl);
        toast(t('ui.toast_download_started'), 'success');
      } catch(e){ toast(t('ui.toast_download_failed'), 'error', { details: e?.message||String(e) }); }
    }
  </script>
  <script>
    // override: enhanced diff rendering + chart vibration
    function updateEstimatesView(apiData, fromChat=false) {
      if (!apiData || !apiData.estimates) return;
      const ests = apiData.estimates;
      const prev = (window.prevEstimates || window.lastEstimates || []);
      window.lastEstimates = ests;
      window.prevEstimates = JSON.parse(JSON.stringify(ests));
      const prevMap = new Map();
      try { (prev||[]).forEach(e => prevMap.set((e.deliverable_name||e.name||''), e)); } catch(_) {}

      // アコーディオン形式で更新
      const accordion = document.getElementById('result-accordion');
      accordion.innerHTML = '';

      ests.forEach((item, index) => {
        const name = item.deliverable_name || item.name || '';
        const desc = item.deliverable_description || item.description || '';
        const pdNum = Number(item.person_days || 0);
        const pd = pdNum.toFixed(1);
        const amtNum = Math.round(item.amount || 0);
        const amt = amtNum.toLocaleString();
        const breakdown = (item.reasoning_breakdown || item.reasoning || '').toString();
        const notes = (item.reasoning_notes || '').toString();
        const htmlBreakdown = DOMPurify.sanitize(marked.parse(breakdown));
        const htmlNotes = DOMPurify.sanitize(marked.parse(notes));

        const prevItem = prevMap.get(name);
        let deltaPd = 0, deltaAmt = 0;
        if (prevItem) {
          deltaPd = Number(pdNum - Number(prevItem.person_days||0));
          deltaAmt = Math.round(amtNum - Math.round(prevItem.amount||0));
        }
        const changed = Math.abs(deltaPd) >= 0.1 || Math.abs(deltaAmt) >= 1;
        const pdBadge = changed && Math.abs(deltaPd) >= 0.1 ? `<span class="ml-2 text-xs ${deltaPd>0?'text-rose-600':'text-emerald-600'}">${deltaPd>0?'+':''}${deltaPd.toFixed(1)}</span>` : '';
        const amtBadge = changed && Math.abs(deltaAmt) >= 1 ? `<span class="ml-2 text-xs ${deltaAmt>0?'text-rose-600':'text-emerald-600'}">${deltaAmt>0?'+':''}${deltaAmt.toLocaleString()}</span>` : '';
        const rowDiffClass = changed ? (deltaAmt>0 || deltaPd>0 ? 'diff-down' : 'diff-up') : '';

        const accordionItem = document.createElement('div');
        accordionItem.className = `rounded-lg border border-slate-200 bg-white overflow-hidden ${rowDiffClass}`;
        accordionItem.dataset.accordionIndex = index;

        accordionItem.innerHTML = `
          <button class="w-full px-4 py-3 flex items-center justify-between hover:bg-slate-50 transition-colors" onclick="toggleAccordion(${index})">
            <div class="flex-1 text-left">
              <div class="flex items-center gap-3">
                <div class="font-medium text-slate-900">${name}</div>
                <div class="text-sm text-slate-600">${desc}</div>
              </div>
            </div>
            <div class="flex items-center gap-4 text-sm">
              <div class="text-right">
                <div class="text-slate-500 text-xs">工数</div>
                <div class="font-semibold tabular-nums">${pd}人日${pdBadge}</div>
              </div>
              <div class="text-right">
                <div class="text-slate-500 text-xs">金額</div>
                <div class="font-semibold tabular-nums">${amt}円${amtBadge}</div>
              </div>
              <svg class="w-5 h-5 text-slate-400 transition-transform duration-200 accordion-icon-${index}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </div>
          </button>
          <div class="accordion-content-${index} hidden px-4 py-3 border-t border-slate-200 bg-slate-50">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <div class="text-sm font-semibold text-slate-900 mb-2">工数内訳</div>
                <div class="text-sm text-slate-700 prose prose-slate max-w-none">${htmlBreakdown}</div>
              </div>
              <div>
                <div class="text-sm font-semibold text-slate-900 mb-2">根拠・備考</div>
                <div class="text-sm text-slate-700 prose prose-slate max-w-none">${htmlNotes}</div>
              </div>
            </div>
          </div>
        `;

        accordion.appendChild(accordionItem);
      });

      // 合計更新
      if (apiData.totals) {
        document.getElementById('subtotal').textContent = Math.round(apiData.totals.subtotal).toLocaleString();
        document.getElementById('tax').textContent = Math.round(apiData.totals.tax).toLocaleString();
        document.getElementById('total').textContent = Math.round(apiData.totals.total).toLocaleString();
      } else {
        const subtotal = (ests||[]).reduce((a,c)=>a+Math.round(c.amount||0),0);
        const tax = Math.round(subtotal*0.1);
        const total = subtotal + tax;
        document.getElementById('subtotal').textContent = subtotal.toLocaleString();
        document.getElementById('tax').textContent = tax.toLocaleString();
        document.getElementById('total').textContent = total.toLocaleString();
      }

      // 棒グラフを疑似振動で更新（色は固定）
      renderChart(ests, (prev && prev.length)? prev : null);
    }
  </script>
</body>
</html>
